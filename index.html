<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurateur Biallais - v4.6</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#28a745">
    
    <style>
        .hidden { display: none !important; }
        .bg-fallback { background-color: #f8f9fa; }
        .trigger-rouge { border: 2px solid #e57373; background-color: #ffebee; cursor:pointer; text-align:center; border-radius:8px; padding:5px; height:100px; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .mt-15 { margin-top: 15px; } .mb-10 { margin-bottom: 10px; }
        .w-full { width: 100%; } .flex-gap { display:flex; gap:10px; }
    </style>
</head>
<body>

    <header class="site-header">
        <div class="logo-container">
            <img src="biallais_logo.png" alt="Logo Biallais" class="main-logo">
        </div>
        <h1>Configurateur de Parement Biacolor</h1>
    </header>
    
    <div class="app-wrapper">
        <div class="config-panel">
            
           <div class="config-section">
                <label class="section-title">1. Format du produit</label>
                
                <div id="container-produit" class="custom-grid-list single-choice">
                    <div class="custom-option selected" data-value="p1"><img src="vignette_p1.png"><span>Bloc 19x19x39</span></div>
                    <div class="custom-option" data-value="p2"><img src="vignette_p2.png"><span>Bloc 15x19x39</span></div>
                    <div class="custom-option" data-value="p3"><img src="vignette_p3.png"><span>Bloc 9x19x39</span></div>
                    <div class="custom-option" data-value="p4"><img src="vignette_p4.png"><span>Maxibrique 6x22x22</span></div>
                    <div class="custom-option" data-value="p5"><img src="vignette_p5.png"><span>Brique 6x10,5x22</span></div>
                    <div class="custom-option" data-value="p6"><img src="vignette_p6.png"><span>Plaquette 6x2x22</span></div>
                    <div class="custom-option" data-value="p7"><img src="vignette_p7.png"><span>Maxibrique 19x09x24</span></div>
                    <div class="custom-option" data-value="p8"><img src="vignette_p8.png"><span>Brique allong√©e 6x11x44</span></div>
                    <div class="custom-option" data-value="p9"><img src="vignette_p9.png"><span>Plaquette allong√©e 6x1,8x44</span></div>
                </div> 
                <div id="info-epaisseur" class="info-box hidden"></div>

                <div id="msg-instruction-couleur" class="instruction-box hidden">
                    üëâ Veuillez maintenant s√©lectionner une <strong>couleur</strong> ci-dessous.
                </div>
            </div>
            <div class="config-section">
                <label class="section-title">2. Couleur du/des produit(s)</label>
                <div id="select-couleur">
                    
                    <div class="standard-colors-wrapper">
                        <span class="standard-colors-label">Coloris Standards</span>
                        <div class="custom-grid-list multi-choice">
                            <div class="custom-option" data-value="blanc" data-fallback="#ecf0f1"><img src="vignette_blanc.png"><span>Blanc</span></div>
                            <div class="custom-option" data-value="tonpierre" data-fallback="#e6d8ad"><img src="vignette_tonpierre.png"><span>Ton Pierre</span></div>
                            <div class="custom-option" data-value="jaune" data-fallback="#f1c40f"><img src="vignette_jaune.png"><span>Jaune</span></div>
                            <div class="custom-option" data-value="saumon" data-fallback="#ffab91"><img src="vignette_saumon.png"><span>Saumon</span></div>
                            
                            <div style="position: relative;">
                                <div class="category-trigger trigger-rouge" id="btn-open-rouges">
                                    <div style="pointer-events: none;">
                                        <span style="font-size:1.5rem;">üé®</span>
                                        <span style="font-weight:bold; color:#c62828; font-size:0.8rem; display:block;">Gamme<br>Rouges</span>
                                    </div>
                                </div>
                                <div id="sub-palette-rouge" class="pop-in hidden">
                                    <div class="custom-grid-list multi-choice">
                                        <div class="custom-option" data-value="rouge" data-fallback="#c0392b"><img src="vignette_rouge.png"><span>Rouge (Std)</span></div>
                                        <div class="custom-option" data-value="terredesienne" data-fallback="#A0522D"><img src="vignette_terredesienne.png"><span>Terre Sienne</span></div>
                                        <div class="custom-option" data-value="orange" data-fallback="#E67E22"><img src="vignette_orange.png"><span>Orange</span></div>
                                        <div class="custom-option" data-value="corail" data-fallback="#FF7F50"><img src="vignette_corail.png"><span>Corail</span></div>
                                        <div class="custom-option" data-value="tomette" data-fallback="#BF5841"><img src="vignette_tomette.png"><span>Tomette</span></div>
                                        <div class="custom-option" data-value="carmin" data-fallback="#960018"><img src="vignette_carmin.png"><span>Carmin</span></div>
                                        <div class="custom-option" data-value="liedevin" data-fallback="#581845"><img src="vignette_liedevin.png"><span>Lie de Vin</span></div>
                                    </div>
                                </div>
                            </div>

                            <div class="custom-option" data-value="chocolat" data-fallback="#5d4037"><img src="vignette_chocolat.png"><span>Chocolat</span></div>
                            <div class="custom-option" data-value="brun" data-fallback="#795548"><img src="vignette_brun.png"><span>Brun</span></div>
                            <div class="custom-option" data-value="grisclair" data-fallback="#bdc3c7"><img src="vignette_grisclair.png"><span>Gris Clair</span></div>
                            <div class="custom-option" data-value="grisfonce" data-fallback="#7f8c8d"><img src="vignette_grisfonce.png"><span>Gris Fonc√©</span></div>
                            <div class="custom-option" data-value="anthracite" data-fallback="#2c3e50"><img src="vignette_anthracite.png"><span>Anthracite</span></div>
                        </div>
                    </div>

                    <div class="special-colors-wrapper">
                        <span class="special-colors-label">‚ú® Coloris Sp√©ciaux</span>
                        <div class="custom-grid-list multi-choice">
                            <div class="custom-option" data-value="superblanc" data-fallback="#ffffff"><img src="vignette_superblanc.png"><span>Super blanc</span></div>
                            <div class="custom-option" data-value="bleu" data-fallback="#3498db"><img src="vignette_bleu.png"><span>Bleu</span></div>
                            <div class="custom-option" data-value="vert" data-fallback="#2ecc71"><img src="vignette_vert.png"><span>Vert</span></div>
                        </div>
                    </div>
                </div> 
                <div id="container-color-dist" class="hidden mt-15" style="background: #f8f9fa; padding: 10px; border: 1px solid #eee;">
                    <div id="dynamic-sliders-container"></div>
                </div>
            </div> 
            
            <div class="config-section"> 
                <label class="section-title">3. Finition(s)</label>
                <div id="container-finition" class="custom-select-list multi-choice">
                    <div class="custom-option selected" data-value="lisse"><img src="vignette_lisse.png"><span>Aspect Lisse</span></div>
                    <div class="custom-option" data-value="roc"><img src="vignette_roc.png"><span>Aspect Roc</span></div>
                </div>
                <div id="msg-astuce-roc" class="info-box hidden mt-15">
                    <span><strong>Astuce :</strong> S√©lectionnez "Aspect Roc" pour d√©bloquer les options.</span>
                </div>

                <div id="container-roc-options" class="hidden mt-15" style="border-top: 1px dashed #eee; padding-top: 15px;">
                    <label class="sub-label">Forcer une ligne sp√©cifique <span id="info-max-lines"></span> :</label>
                    <div class="rule-builder">
                        <div class="flex-gap">
                            <input type="text" id="new-line-number" placeholder="N¬∞" class="form-control small-input" style="width: 60px;">
                            <select id="new-line-finish" class="form-control small-input" style="width: 80px;"><option value="roc">Roc</option><option value="lisse">Lisse</option></select>
                            <select id="new-line-color" class="form-control small-input" style="flex:1;">
                                <option value="blanc" selected>Blanc</option><option value="tonpierre">Ton Pierre</option><option value="jaune">Jaune</option>
                                <option value="saumon">Saumon</option><option value="rouge">Rouge</option><option value="chocolat">Chocolat</option>
                                <option value="brun">Brun</option><option value="grisclair">Gris Clair</option><option value="grisfonce">Gris Fonc√©</option>
                                <option value="anthracite">Anthracite</option><option value="superblanc">Super Blanc</option><option value="bleu">Bleu</option>
                                <option value="vert">Vert</option><option value="terredesienne">Terre de Sienne</option><option value="orange">Orange</option>
                                <option value="corail">Corail</option><option value="tomette">Tomette</option><option value="carmin">Carmin</option><option value="liedevin">Lie de Vin</option>
                            </select>
                        </div>
                        <div class="flex-gap mt-15">
                            <select id="new-line-joint" class="form-control small-input" style="width: 140px;">
                                <option value="">Joint Ligne (Auto)</option><option value="joint_grisclair.png">Gris Clair</option><option value="joint_blanc.png">Blanc</option>
                                <option value="joint_tonpierre.png">Ton Pierre</option><option value="joint_grisfonce.png">Gris Fonc√©</option><option value="joint_anthracite.png">Anthracite</option>
                            </select>
                            <button id="btn-add-rule" class="btn-mini w-full">APPLIQUER +</button>
                            <button id="btn-reset-rules" class="btn-mini btn-danger" title="Tout effacer">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div id="active-rules-container" class="tags-container mt-15"></div>
                </div>
                <div id="wrapper-repartition" class="hidden mt-15" style="background: #f1f3f5; padding: 10px;">
                    <label class="sub-label">R√©partition du "Roc" : <span id="slider-roc-valeur">25%</span></label>
                    <div class="slider-container"><input type="range" id="slider-roc" min="0" max="100" value="25" step="5"></div>
                </div>
            </div>

            <div class="config-section">
                <label class="section-title">4. Couleur du Joint Global</label>
                <select id="select-joint" class="form-control">
                    <option value="joint_grisclair.png">Gris Clair (Standard)</option><option value="joint_blanc.png">Blanc</option>
                    <option value="joint_superblanc.png">Super Blanc</option><option value="joint_tonpierre.png">Ton Pierre</option>
                    <option value="joint_saumon.png">Saumon</option><option value="joint_rouge.png">Rouge</option>
                    <option value="joint_jaune.png">Jaune</option><option value="joint_brun.png">Brun</option>
                    <option value="joint_chocolat.png">Chocolat</option><option value="joint_grisfonce.png">Gris Fonc√©</option>
                    <option value="joint_anthracite.png">Anthracite</option>
                </select>
            </div>

            <details class="advanced-settings-container">
                <summary class="advanced-summary">‚öôÔ∏è Param√®tres Avanc√©s</summary>
                <div class="advanced-content">
                    <div class="config-section">
                        <label class="sub-label">Appareillage :</label>
                        <select id="select-appareillage" class="form-control">
                            <option value="demi-brique">Pose en demi-brique</option><option value="aligne">Pose align√©e</option>
                            <option value="tiers">Pose en 1/3 - 2/3</option><option value="flamand">Appareillage Flamand (Belge)</option>
                            <option value="anglais">Appareillage Anglais</option><option value="moucharabieh">Moucharabieh (Perfor√©)</option>
                        </select>
                    </div>
                    <div class="config-section">
                        <label class="sub-label">Type de joint :</label>
                        <select id="select-type-joint" class="form-control mb-10">
                            <option value="plat">Joint Plat (Standard)</option><option value="demi-rond">Joint Demi-Rond (Concave)</option>
                        </select>
                        <div class="slider-container">
                            <label for="slider-joint-h">√âpaisseur H :</label><input type="range" id="slider-joint-h" min="8" max="20" value="10" step="1"><span id="slider-joint-h-valeur">10 mm</span>
                        </div>
                        <div class="slider-container">
                            <label for="slider-joint-v">√âcartement V :</label><input type="range" id="slider-joint-v" min="1" max="20" value="10" step="1"><span id="slider-joint-v-valeur">10 mm</span>
                        </div>
                    </div>
                    <div id="container-relief-section" class="config-section mt-15" style="border-top:1px dashed #eee; padding-top:15px;">
                        <label class="sub-label">Effet de Profondeur (Relief 3D) :</label>
                        <select id="select-relief-type" class="form-control mb-10">
                            <option value="none">Aucun (Mur plat)</option><option value="random-out">Briques en Saillie</option>
                            <option value="random-in">Briques en Retrait</option><option value="random-mix">Mixte (Avanc√©es + Recul√©es)</option>
                        </select>
                        <div class="slider-container hidden" id="container-relief-percent">
                            <label>Proportion :</label><input type="range" id="slider-relief-percent" min="0" max="50" value="10" step="5"><span id="slider-relief-valeur">10%</span>
                        </div>
                        <div id="container-relief-out-options" class="hidden mt-15 bg-fallback p-2">
                            <label class="sub-label">‚¨ÜÔ∏è Saillie :</label>
                            <div class="flex-gap">
                                <select id="select-relief-color" class="form-control"><option value="auto">üé® Auto</option><option value="blanc">Blanc</option><option value="tonpierre">Ton Pierre</option><option value="anthracite">Anthracite</option></select>
                                <select id="select-relief-finish" class="form-control"><option value="auto">üß± Auto</option><option value="lisse">Lisse</option><option value="roc">Roc</option></select>
                            </div>
                        </div>
                        <div id="container-relief-in-options" class="hidden mt-15 bg-fallback p-2">
                            <label class="sub-label">‚¨áÔ∏è Retrait :</label>
                            <div class="flex-gap">
                                <select id="select-relief-in-color" class="form-control"><option value="auto">üé® Auto</option><option value="grisfonce">Gris Fonc√©</option></select>
                                <select id="select-relief-in-finish" class="form-control"><option value="auto">üß± Auto</option></select>
                            </div>
                        </div>
                    </div>
                </div>
            </details>

            <button id="genererBouton" class="btn-primary">Mettre √† jour le rendu</button>
            <button id="btnReset" class="btn-reset" title="Remettre √† z√©ro">üîÑ R√©initialiser la configuration</button>

            <div class="export-section">
                <p class="export-label">T√©l√©charger :</p>
                <div class="export-buttons-row">
                    <button id="btnExportJpg" class="btn-secondary">JPG</button>
                    <button id="btnExportPng" class="btn-secondary">PNG</button>
                    <button id="btnExportPdf" class="btn-secondary">PDF</button>
                    <button id="btnExportCCTP" class="btn-secondary" style="background:#17a2b8;">üìÑ CCTP</button>
                </div>
            </div>
            <div id="app-version" class="version-label"></div>
        </div> 

        <div class="resizer" id="dragMe"></div>

        <div class="preview-panel">
            <div class="canvas-container-wrapper">
                <div id="loading-overlay" class="hidden"><div class="spinner"></div><span>G√©n√©ration...</span></div>
                <div id="initial-overlay">
                    <video src="Vid√©o_de_cube_en_rotation.mp4" autoplay loop muted playsinline class="logo-attente" style="width: 200px; opacity: 0.9; margin-bottom: 20px;"></video>
                    <p style="font-weight:bold;">En attente de configuration</p>
                </div>
                <div id="wall-pattern-layer"></div>
                <canvas id="apercuCanvas"></canvas> 
            </div> 

            <div class="preview-toolbar">
                <div class="toolbar-group">
                    <label>Vue :</label>
                    <select id="select-scene" class="form-control-sm"><option value="neutre">üîç Neutre</option><option value="facade">üè† Fa√ßade</option><option value="jardin">üìê Jardin</option></select>
                </div>
                <div id="zoom-controls" class="toolbar-group">
                    <label>Zoom :</label><input type="range" id="zoom-slider" min="1" max="3" step="0.1" value="1">
                </div>
            </div>

            <div class="preview-info"><span id="dimensions-info"></span></div>
            
            <div class="tech-summary" id="tech-summary">
                <h4>üìä Estimation Technique</h4>
                <div class="project-surface-input mb-10" style="background:#e7f1ff; padding:10px;">
                    <label>Surface Totale (m¬≤) :</label>
                    <div class="flex-gap"><input type="number" id="user-global-surface" placeholder="Ex: 100" class="form-control"><span style="align-self:center;">m¬≤</span></div>
                </div>
                <div class="summary-grid">
                    <div class="sum-item"><span class="sum-label">Surface :</span><span class="sum-value" id="sum-surface">0 m¬≤</span></div>
                    <div class="sum-item"><span class="sum-label">√âl√©ments :</span><span class="sum-value" id="sum-briques">0</span></div>
                </div>
                <table class="distribution-table"><thead><tr><th>Produit</th><th>%</th><th>Surface</th><th>Qt√©</th></tr></thead><tbody id="distribution-body"></tbody></table>
                <div id="mortier-section" class="mt-15" style="background:#f1f3f5; padding:10px;">
                    <h5 style="margin:0 0 5px 0;">üß± Joints</h5><div id="mortier-details-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('error', function(e) {
            if (e.target.tagName.toLowerCase() === 'img') {
                // Si c'est le logo principal, on cache
                if(e.target.classList.contains('main-logo')) { e.target.style.display = 'none'; return; }
                
                // Si c'est une option de couleur/produit
                const parent = e.target.closest('.custom-option');
                if(parent) {
                    // Si on a d√©fini une couleur de repli (data-fallback)
                    if(parent.dataset.fallback) {
                        e.target.style.backgroundColor = parent.dataset.fallback;
                        e.target.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; // 1x1px transparent
                        e.target.style.objectFit = "cover";
                    } else {
                        // Sinon on met un placeholder gris
                        e.target.src = 'https://placehold.co/100x60?text=' + (parent.querySelector('span')?.textContent || 'IMG');
                    }
                }
            }
        }, true);
    </script>
    <script src="config.js"></script>
</body>
</html>